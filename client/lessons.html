<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Hanzi SRS — Choose Lessons" />
  <meta name="theme-color" content="#0b0f19" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <title>Hanzi SRS — Choose Lessons</title>

  <style>
    /* ---------- Reset & tokens ---------- */
    *,*::before,*::after{box-sizing:border-box}
    body,h1,h2,h3,h4,p,figure,blockquote,dl,dd{margin:0}
    img,svg,video,canvas,audio,iframe{display:block;max-width:100%}
    input,button,textarea,select{font:inherit}
    :root{color-scheme:dark light}
    :root{
      /* Dark defaults (unchanged) */
      --bg:#0b0f19; --bg-2:#0e1423; --text:#e5e7eb; --muted:#98a2b3;
      --surface:rgba(255,255,255,.04); --surface-2:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --accent:hsl(257 90% 66%); --accent-2:hsl(190 90% 60%);
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.30), 0 2px 8px rgba(0,0,0,.18);
      --radius:16px; --container:1200px; --gap:20px;
      --tile:90px; --tile-font:36px; --tile-font-voc:36px;
      --sel-ring:2px;
      --tile-bg: var(--bg);
    }

    /* ---------- Light mode palette (high contrast & visible text) ---------- */
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fb; --bg-2:#eef2f8; --text:#0b1220; --muted:#667085;
        --surface:#ffffff; --surface-2:#f3f6fb; --border:#d7dee9;
        --shadow:0 10px 30px rgba(11,18,32,.06), 0 2px 8px rgba(11,18,32,.04);
        --tile-bg:#ffffff;
      }
    }
    html[data-theme="light"]{
      --bg:#f6f8fb; --bg-2:#eef2f8; --text:#0b1220; --muted:#667085;
      --surface:#ffffff; --surface-2:#f3f6fb; --border:#d7dee9;
      --shadow:0 10px 30px rgba(11,18,32,.06), 0 2px 8px rgba(11,18,32,.04);
      --tile-bg:#ffffff;
    }
    html[data-theme="dark"]{
      --bg:#0b0f19; --bg-2:#0e1423; --text:#e5e7eb; --muted:#98a2b3;
      --surface:rgba(255,255,255,.04); --surface-2:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.30), 0 2px 8px rgba(0,0,0,.18);
      --tile-bg: var(--bg);
    }

    body{
      min-height:100vh; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; line-height:1.55;
    }
    .bg-wrap{position:fixed; inset:0; z-index:-1; overflow:hidden;
      background:
        radial-gradient(1000px 420px at 82% -10%, color-mix(in oklab, var(--accent), transparent 78%), transparent 75%),
        radial-gradient(900px 360px at 0% 0%, color-mix(in oklab, var(--accent-2), transparent 82%), transparent 75%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 40%, var(--bg) 100%)}
    .bg-grid{position:absolute; inset:-1px; background:
      linear-gradient(transparent 97%, var(--border) 100%) 0 0 / 40px 40px,
      linear-gradient(90deg, transparent 97%, var(--border) 100%) 0 0 / 40px 40px;
      mask-image: radial-gradient(80% 60% at 50% 10%, #000 0%, #000 60%, transparent 85%); opacity:.24}

    .container{max-width:var(--container); margin-inline:auto; padding-inline: clamp(16px,3vw,32px)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}

    /* ---------- Nav ---------- */
    .nav{position:sticky; top:0; z-index:60; backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg), transparent 55%); border-bottom:1px solid var(--border)}
    .nav-inner{height:64px; display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:10px; align-items:center; color:inherit; text-decoration:none; font-weight:900}
    .brand-badge{width:32px; height:32px; display:grid; place-items:center; border-radius:10px; color:white;
      background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow)}
    .mini{font-size:.78rem; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
    .btn{display:inline-flex; align-items:center; gap:10px; border:1px solid var(--border); background:var(--surface);
      padding:10px 14px; border-radius:12px; color:var(--text); text-decoration:none; cursor:pointer; font-weight:800; transition:transform .15s ease}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:none}

    /* ---------- Hero ---------- */
    .panel{background:linear-gradient(180deg, var(--surface-2), transparent); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
    h1{font-size:clamp(1.35rem, 2.1vw, 1.7rem); font-weight:900}
    .muted{color:var(--muted)}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px}
    .kbd{padding:2px 6px; border:1px solid var(--border); border-radius:6px; font-variant-numeric:tabular-nums}

    /* ---------- Center stage tabs ---------- */
    .tabs{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .tab{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; border:1px solid var(--border);
      background:var(--surface); color:var(--text); font-weight:900; cursor:pointer; transition: all .2s ease;
    }
    .tab[aria-selected="true"]{
      background:var(--surface); color:var(--text);
      box-shadow:inset 0 0 0 2px color-mix(in oklab, var(--accent), transparent 30%);
      border-color:color-mix(in oklab, var(--accent), transparent 60%);
    }
    .tab .count{opacity:.9; color:var(--muted); font-variant-numeric:tabular-nums}

    /* Hard override to prevent accidental white text in light mode (fix) */
    html[data-theme="light"] .tab,
    html[data-theme="light"] .tab[aria-selected="true"]{ color:var(--text) !important }
    html[data-theme="light"] .tab .count{ color:var(--muted) !important }

    /* ---------- Filters bar ---------- */
    .filters{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .sel, .tog{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--surface); cursor:pointer
    }
    select{background:transparent; color:inherit; border:none; outline:none}
    .tog input{accent-color: currentColor}

    /* ---------- Board ---------- */
    .board{margin-top:12px; border:1px solid var(--border); border-radius:16px; background:var(--surface); box-shadow:var(--shadow)}
    .board-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border)}
    .board-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .board-btn{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--bg-2); font-weight:800; cursor:pointer; color:var(--text)}
    .board-btn.primary{border:none; background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:white}
    .grid{
      display:grid; gap:10px; padding:12px;
      grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr));
      grid-auto-flow: dense;
    }

    /* ---------- Tiles ---------- */
    .tile{
      --ring:transparent;
      position:relative; display:flex; align-items:center; justify-content:center;
      min-height:var(--tile); border:1px solid var(--border); border-radius:14px;
      background:var(--tile-bg); color:var(--text);
      font-weight:900; letter-spacing:.02em; cursor:pointer; user-select:none;
      transition:border-color .15s ease, background .15s ease, transform .10s ease, box-shadow .15s ease;
      outline: none; box-shadow: inset 0 0 0 var(--sel-ring) var(--ring);
    }
    .tile:hover{transform:translateY(-1px); border-color:color-mix(in oklab, var(--accent), transparent 65%)}
    .tile:focus-visible{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent), transparent 60%)}
    .tile.selected{--ring: color-mix(in oklab, var(--accent), transparent 80%); border-color: color-mix(in oklab, var(--accent), transparent 25%); background:color-mix(in oklab, var(--surface), transparent 0%)}
    .glyph{line-height:1; text-align:center; word-break:keep-all; color:var(--text); font-size:var(--tile-font); padding:8px 6px}
    .tick{
      position:absolute; top:6px; right:6px; width:20px; height:20px; display:grid; place-items:center; border-radius:7px;
      border:1px solid var(--border); background:var(--bg-2); font-size:12px; color:var(--muted); transition:.15s;
    }
    .tile.selected .tick{border:none; background:var(--accent); color:white}
    .tile.locked{opacity:.55; cursor:not-allowed}
    .tile.locked .tick{background:var(--bg-2); color:var(--muted)}
    .tile.locked::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background:repeating-linear-gradient(45deg, transparent 0 8px, rgba(0,0,0,.04) 8px 16px);
    }

    /* ---------- Queue ---------- */
    .queue{
      position:sticky; bottom:0; z-index:50; margin-top:18px;
      background: var(--surface); backdrop-filter: blur(10px); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px
    }
    .queue-list{display:flex; gap:8px; flex-wrap:wrap; align-items:center; max-height:88px; overflow:auto}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--surface); color:var(--text)}
    .chip .x{cursor:pointer; opacity:.75}
    .queue .cta{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; font-weight:900;
      background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:white; border:none; cursor:pointer}
    .queue .cta[disabled]{opacity:.5; cursor:not-allowed}

    footer{border-top:1px solid var(--border); margin-top:26px; padding:22px 0; color:var(--muted)}
  </style>
</head>
<body>
  <div class="bg-wrap" aria-hidden="true"><div class="bg-grid"></div></div>

  <!-- NAV -->
  <nav class="nav" aria-label="Primary">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="Back to dashboard">
        <span class="brand-badge" aria-hidden="true">汉</span>
        <span>Hanzi SRS</span>
        <span class="mini">Choose Lessons</span>
      </a>
      <div class="row">
        <button id="themeBtn" class="btn" aria-label="Toggle theme">
          <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.41-1.41M7.46 7.46 6.05 6.05m12.9 0-1.41 1.41M7.46 16.54l-1.41 1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Theme
        </button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <main class="container" style="margin-top:18px">
    <section class="panel">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div class="stack">
          <h1>Pick items to learn</h1>
          <p class="muted">Minimal, fast picking. Choose <b>Radicals</b> → <b>Hanzi</b> → <b>Vocabulary</b>. Locked items depend on earlier content.</p>
        </div>
        <div class="row">
          <span class="pill">Level <b id="level">—</b></span>
          <span class="pill">Selected <b id="selCount">0</b></span>
          <span class="pill">ETA <b id="eta">~0 min</b></span>
        </div>
      </div>

      <!-- Center-stage tabs -->
      <div class="tabs" style="margin-top:12px" role="tablist" aria-label="Item type">
        <button id="tabRad" class="tab" role="tab" aria-selected="true">Radicals <span id="countRad" class="count">0</span></button>
        <button id="tabHan" class="tab" role="tab" aria-selected="false">Hanzi <span id="countHan" class="count">0</span></button>
        <button id="tabVoc" class="tab" role="tab" aria-selected="false">Vocabulary <span id="countVoc" class="count">0</span></button>
      </div>

      <!-- Filters -->
      <div class="filters" style="margin-top:10px">
        <label class="sel">Scope
          <select id="scope">
            <option value="all">Current + incomplete previous</option>
            <option value="current">Current level only</option>
          </select>
        </label>
        <label class="sel">Show
          <select id="show">
            <option value="avail">Available</option>
            <option value="locked">Locked</option>
            <option value="all">All</option>
          </select>
        </label>
        <label class="tog"><input id="bigTiles" type="checkbox" /> Larger tiles</label>
        <button id="btnRecommend" class="btn">Auto-select recommended</button>
      </div>
    </section>

    <!-- BOARD -->
    <section class="board" aria-live="polite">
      <div class="board-head">
        <div class="row">
          <strong id="boardTitle">Radicals</strong>
          <span class="muted" id="boardSubtitle">Available in scope</span>
        </div>
        <div class="board-actions">
          <button id="btnSelectVisible" class="board-btn">Select visible</button>
          <button id="btnClearVisible" class="board-btn">Clear visible</button>
          <button id="btnShowMore" class="board-btn">Show more</button>
        </div>
      </div>
      <div id="grid" class="grid" aria-label="Items grid"></div>
    </section>

    <!-- QUEUE -->
    <div class="queue" role="region" aria-label="Lesson queue">
      <div class="queue-list" id="queueList"></div>
      <div class="stack" style="align-items:flex-end">
        <div class="row muted"><span id="queueMeta">0 selected · ~0 min</span></div>
        <button id="startLessons" class="cta" disabled>
          Start lessons
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
    </div>
  </main>

  <footer class="container">
    <div class="row" style="justify-content:space-between">
      <span>© <span id="year"></span> Hanzi SRS</span>
      <span>Shortcuts: <span class="kbd">A</span>uto-select · <span class="kbd">S</span>tart</span>
    </div>
  </footer>

  <script>
    /* ---------- Demo profile & constants ---------- */
    const profile = { level: 3, name: 'Learner' };
    const MIN_PER_ITEM = 2;
    const PAGE_SIZE = { rad: 48, han: 72, voc: 90 };

    /* ---------- Theme ---------- */
    const THEME_KEY='hanziSRS_theme';
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(next){
      localStorage.setItem(THEME_KEY, next);
      document.documentElement.setAttribute('data-theme', next==='auto' ? (prefersDark?'dark':'light') : next);
      document.getElementById('themeIcon').innerHTML = (document.documentElement.getAttribute('data-theme')==='dark')
        ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" stroke="currentColor" stroke-width="2" fill="none"/>'
        : '<path d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.41-1.41M7.46 7.46 6.05 6.05m12.9 0-1.41 1.41M7.46 16.54l-1.41 1.41" stroke="currentColor" stroke-width="2" fill="none"/>';
    }
    function initTheme(){ applyTheme(localStorage.getItem(THEME_KEY) || 'auto') }
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme') || (prefersDark?'dark':'light');
      applyTheme(cur==='dark' ? 'light' : 'dark');
    });

    /* ---------- Demo Data ---------- */
    const RAD_CHARS = ['氵','讠','宀','女','子','口','亻','心','手','目','日','月','木','火','水','土','金','石','纟','辶','阝','忄','扌','艹','衤'];
    const HZ_CHARS  = ['中','国','人','大','小','天','水','火','山','口','手','目','女','子','心','言','好','安','语','学','字','日','月','木','林','森','上','下','左','右','吃','喝','见','来','去','朋','友','家','书','车'];
    const RAD = RAD_CHARS.slice(0, 22).map((c,i)=>({ id:'rad_'+i, char:c, level: (i%3)+1, passed: i%4===0 }));
    const HZ  = HZ_CHARS.slice(0, 40).map((c,i)=>{
      const r1 = RAD[i % RAD.length].id;
      const r2 = RAD[(i*3) % RAD.length].id;
      return { id:'hz_'+i, char:c, level: (i%3)+1, prereqRad:[r1, r2], passed: i%9===0 };
    });
    const VOC = [];
    for(let i=0;i<150;i++){
      const h1 = HZ[i % HZ.length], h2 = HZ[(i*7) % HZ.length], h3 = HZ[(i*11)%HZ.length];
      const term = (i%3===0) ? (h1.char + h2.char + h3.char) : (h1.char + h2.char);
      const prereq = Array.from(new Set([h1.id, h2.id, (i%3===0? h3.id:null)].filter(Boolean)));
      VOC.push({ id:'vc_'+i, term, level: (i%3)+1, prereqHz: prereq, passed: i%13===0 });
    }

    /* ---------- Helpers ---------- */
    const $ = (s)=>document.querySelector(s);
    const el = (id)=>document.getElementById(id);

    const selected = new Set(); // keys "rad:id", "han:id", "voc:id"
    const state = { tab:'rad', scope:'all', show:'avail', visible:{rad:PAGE_SIZE.rad, han:PAGE_SIZE.han, voc:PAGE_SIZE.voc}, big:false };

    function key(kind, id){ return `${kind}:${id}` }
    function isSelected(kind, id){ return selected.has(key(kind,id)) }
    function addSel(kind, id){ selected.add(key(kind,id)) }
    function removeSel(kind, id){ selected.delete(key(kind,id)) }
    function withinScope(level){ return state.scope==='current' ? level===profile.level : level<=profile.level }

    function computeAvailability(){
      const knownRad = new Set(RAD.filter(r=>r.passed).map(r=>r.id));
      const knownHz  = new Set(HZ.filter(h=>h.passed).map(h=>h.id));
      const radAll = RAD.filter(r=>withinScope(r.level));
      const radAvail = radAll.filter(r=>!r.passed);
      const radLocked = [];
      const hzAll = HZ.filter(h=>withinScope(h.level));
      const hzCand = hzAll.filter(h=>!h.passed);
      const hzAvail = hzCand.filter(h=> h.prereqRad.every(id=>knownRad.has(id)) );
      const hzLocked= hzCand.filter(h=> !h.prereqRad.every(id=>knownRad.has(id)) );
      const vocAll = VOC.filter(v=>withinScope(v.level));
      const vocCand = vocAll.filter(v=>!v.passed);
      const vocAvail = vocCand.filter(v=> v.prereqHz.every(id=>knownHz.has(id)) );
      const vocLocked= vocCand.filter(v=> !v.prereqHz.every(id=>knownHz.has(id)) );

      return {
        rad: { avail: radAvail, locked: radLocked, all: radAvail.concat(radLocked) },
        han: { avail: hzAvail,  locked: hzLocked,  all:   hzAvail.concat(hzLocked) },
        voc: { avail: vocAvail, locked: vocLocked, all:  vocAvail.concat(vocLocked) }
      };
    }

    function counts(av){
      el('countRad').textContent = av.rad.avail.length;
      el('countHan').textContent = av.han.avail.length;
      el('countVoc').textContent = av.voc.avail.length;
    }

    /* ---------- Dynamic vocab sizing ---------- */
    function sizeGlyph(span, isVocab){
      if(!span) return;
      if(!isVocab){
        span.style.fontSize = getComputedStyle(document.documentElement).getPropertyValue('--tile-font').trim(); return;
      }
      const len = Array.from(span.textContent||'').length;
      const base = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile-font-voc')) || 36;
      const floor = state.big ? 22 : 18;
      const size = Math.max(floor, base - (len-1)*5);
      span.style.fontSize = size + 'px';
      const tile = span.closest('.tile');
      tile.style.gridColumn = '';
      if(len>=3) tile.style.gridColumn = 'span 2';
      if(len>=5) tile.style.gridColumn = 'span 3';
    }

    /* ---------- Render grid ---------- */
    function renderGrid(){
      const av = computeAvailability();
      counts(av);

      const title = state.tab==='rad' ? 'Radicals' : state.tab==='han' ? 'Hanzi' : 'Vocabulary';
      el('boardTitle').textContent = title;
      el('boardSubtitle').textContent = (state.show==='avail' ? 'Available in scope' : state.show==='locked' ? 'Locked (prerequisites missing)' : 'All items in scope');

      const pool = av[state.tab][state.show];
      const visible = state.visible[state.tab];
      const toShow = pool.slice(0, visible);

      const grid = el('grid');
      grid.innerHTML = '';
      const tileSize = state.big ? 104 : 90;
      grid.style.setProperty('--tile', tileSize + 'px');
      document.documentElement.style.setProperty('--tile-font', (state.big ? 42 : 36) + 'px');
      document.documentElement.style.setProperty('--tile-font-voc', (state.big ? 42 : 36) + 'px');

      toShow.forEach(item=>{
        const locked = (state.show==='locked');
        const tile = document.createElement('button');
        tile.className = 'tile' + (locked?' locked':'') + (isSelected(state.tab, item.id)?' selected':'');
        tile.type='button';
        tile.setAttribute('role','checkbox');
        tile.setAttribute('aria-checked', isSelected(state.tab,item.id));

        const glyph = document.createElement('span');
        glyph.className='glyph';
        glyph.textContent = (state.tab==='voc' ? item.term : item.char);
        tile.appendChild(glyph);

        const tick = document.createElement('span');
        tick.className='tick';
        tick.textContent = locked ? '🔒' : '✓';
        tile.appendChild(tick);

        if(!locked){
          tile.addEventListener('click', ()=>{
            const was = isSelected(state.tab, item.id);
            if(was){ removeSel(state.tab, item.id); tile.classList.remove('selected'); tile.setAttribute('aria-checked','false'); }
            else   { addSel(state.tab, item.id);     tile.classList.add('selected');   tile.setAttribute('aria-checked','true');  }
            refreshQueue();
          });
        }

        grid.appendChild(tile);
        sizeGlyph(glyph, state.tab==='voc');
      });

      el('btnShowMore').disabled = visible >= pool.length;
    }

    /* ---------- Queue ---------- */
    function refreshQueue(){
      el('selCount').textContent = selected.size;
      el('eta').textContent = `~${selected.size*MIN_PER_ITEM} min`;
      const list = el('queueList'); list.innerHTML='';
      const items = Array.from(selected).slice(0, 30);
      for(const k of items){
        const [kind, id] = k.split(':');
        const meta = (kind==='rad' ? RAD.find(r=>r.id===id) : kind==='han' ? HZ.find(h=>h.id===id) : VOC.find(v=>v.id===id));
        const label = (kind==='voc' ? meta.term : meta.char);
        const chip = document.createElement('div'); chip.className='chip';
        chip.innerHTML = `<span class="pill">${kind.toUpperCase()}</span><b style="font-size:18px">${label}</b><span class="x" title="Remove">✕</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{ removeSel(kind,id); refreshQueue(); renderGrid(); });
        list.appendChild(chip);
      }
      const overflow = selected.size - items.length;
      if(overflow>0){ const more=document.createElement('div'); more.className='chip muted'; more.textContent = `+${overflow} more`; list.appendChild(more) }
      el('queueMeta').textContent = `${selected.size} selected · ~${selected.size*MIN_PER_ITEM} min`;
      el('startLessons').disabled = selected.size===0;
    }

    /* ---------- Controls ---------- */
    function bindControls(){
      el('tabRad').addEventListener('click', ()=> setTab('rad'));
      el('tabHan').addEventListener('click', ()=> setTab('han'));
      el('tabVoc').addEventListener('click', ()=> setTab('voc'));

      el('scope').addEventListener('change', (e)=>{ state.scope=e.target.value; resetVisible(); renderGrid() });
      el('show').addEventListener('change',  (e)=>{ state.show=e.target.value;  renderGrid() });
      el('bigTiles').addEventListener('change', (e)=>{ state.big = e.target.checked; renderGrid() });

      el('btnShowMore').addEventListener('click', ()=>{ state.visible[state.tab] += PAGE_SIZE[state.tab]; renderGrid() });
      el('btnSelectVisible').addEventListener('click', ()=>{
        if(state.show==='locked') return;
        const pool = computeAvailability()[state.tab]['avail'].slice(0, state.visible[state.tab]);
        pool.forEach(it=> addSel(state.tab, it.id));
        refreshQueue(); renderGrid();
      });
      el('btnClearVisible').addEventListener('click', ()=>{
        const pool = computeAvailability()[state.tab]['all'].slice(0, state.visible[state.tab]);
        pool.forEach(it=> removeSel(state.tab, it.id));
        refreshQueue(); renderGrid();
      });

      el('btnRecommend').addEventListener('click', ()=>{ autoSelect(); refreshQueue(); renderGrid() });
      document.addEventListener('keydown', (e)=>{
        if(e.key.toLowerCase()==='a'){ autoSelect(); refreshQueue(); renderGrid() }
        if(e.key.toLowerCase()==='s' && !el('startLessons').disabled){ el('startLessons').click() }
      });

      el('startLessons').addEventListener('click', ()=>{
        const items = Array.from(selected).join(',');
        window.location.href = `lessons-run.html?items=${encodeURIComponent(items)}`;
      });

      const ro = new ResizeObserver(()=> {
        if(state.tab==='voc'){
          document.querySelectorAll('.grid .tile .glyph').forEach(g=> sizeGlyph(g, true));
        }
      });
      ro.observe(el('grid'));
      window.addEventListener('orientationchange', ()=> {
        if(state.tab==='voc'){
          document.querySelectorAll('.grid .tile .glyph').forEach(g=> sizeGlyph(g, true));
        }
      });
    }

    function setTab(t){
      state.tab = t;
      el('tabRad').setAttribute('aria-selected', t==='rad');
      el('tabHan').setAttribute('aria-selected', t==='han');
      el('tabVoc').setAttribute('aria-selected', t==='voc');
      renderGrid();
    }
    function resetVisible(){ state.visible={ rad:PAGE_SIZE.rad, han:PAGE_SIZE.han, voc:PAGE_SIZE.voc } }

    function autoSelect(){
      const av = computeAvailability();
      const target = 12;
      const order = [
        ...av.rad.avail.slice(0, 6),
        ...av.han.avail.slice(0, 6),
        ...av.voc.avail.slice(0, 12),
      ];
      let n=0; for(const item of order){
        const k = item.term!=null ? `voc:${item.id}` : (item.prereqRad ? `han:${item.id}` : `rad:${item.id}`);
        if(n>=target) break;
        if(!selected.has(k)){ selected.add(k); n++ }
      }
    }

    /* ---------- Init ---------- */
    function init(){
      initTheme();
      document.getElementById('year').textContent = new Date().getFullYear();
      document.getElementById('level').textContent = profile.level;

      refreshQueue();
      renderGrid();
      bindControls();
    }
    init();
  </script>
</body>
</html>
