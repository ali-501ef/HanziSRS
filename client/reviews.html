<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Hanzi SRS — Premium, intuitive review session for Chinese characters with tone‑aware input, examples, and context." />
  <meta name="theme-color" content="#0b0f19" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <title>Hanzi SRS — Reviews</title>

  <style>
    /* ---------- Reset & tokens (consistent theme) ---------- */
    *,*::before,*::after{box-sizing:border-box}
    body,h1,h2,h3,h4,p,figure,blockquote,dl,dd{margin:0}
    img,svg,video,canvas,audio,iframe{display:block;max-width:100%}
    input,button,textarea,select{font:inherit}
    :root{color-scheme:dark light}
    :root{
      --bg:#0b0f19; --bg-2:#0e1423; --text:#e5e7eb; --muted:#98a2b3;
      --surface:rgba(255,255,255,.04); --surface-2:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --accent:hsl(257 90% 66%); --accent-2:hsl(190 90% 60%); --success:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.2);
      --radius:16px; --container:1200px; --gap:24px;
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#fff; --bg-2:#f7f9fc; --text:#0b1220; --muted:#5b6573; --surface:rgba(0,0,0,.04); --surface-2:rgba(0,0,0,.06); --border:rgba(17,24,39,.12);
      --shadow:0 10px 30px rgba(2,6,23,.08),0 2px 8px rgba(2,6,23,.06)}
    }
    body{
      min-height:100vh; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue", Arial;
      text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; line-height:1.5;
    }
    .bg-wrap{position:fixed; inset:0; z-index:-1; overflow:hidden;
      background:
        radial-gradient(1200px 500px at 85% -10%, color-mix(in oklab, var(--accent), transparent 70%), transparent 75%),
        radial-gradient(1000px 400px at 0% 0%, color-mix(in oklab, var(--accent-2), transparent 75%), transparent 75%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 40%, var(--bg) 100%);
    }
    .bg-grid{position:absolute; inset:-1px;
      background:
        linear-gradient(transparent 97%, var(--border) 100%) 0 0 / 40px 40px,
        linear-gradient(90deg, transparent 97%, var(--border) 100%) 0 0 / 40px 40px;
      mask-image: radial-gradient(80% 60% at 50% 10%, #000 0%, #000 60%, transparent 85%); opacity:.35;
    }

    .container{max-width:var(--container); margin-inline:auto; padding-inline: clamp(16px, 3vw, 32px)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .grid{display:grid; gap:var(--gap)}
    .grid-2{grid-template-columns:1.15fr .85fr}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr} }

    /* ---------- Nav ---------- */
    .nav{position:sticky; top:0; z-index:50; backdrop-filter: blur(12px);
      background: color-mix(in oklab, var(--bg), transparent 60%); border-bottom:1px solid var(--border)}
    .nav-inner{height:64px; display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:10px; align-items:center; color:inherit; text-decoration:none; font-weight:800}
    .brand-badge{width:32px; height:32px; display:grid; place-items:center; border-radius:10px; color:white;
      background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow)}
    .mini-badge{font-size:.75rem; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}

    /* ---------- Header bar ---------- */
    .bar{margin:16px 0 8px; background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow)}
    .progress{position:relative; height:12px; background:var(--surface-2); border:1px solid var(--border); border-radius:999px; overflow:hidden; width:min(460px, 60vw)}
    .progress > span{position:absolute; inset:0; transform-origin:left; transform:scaleX(0);
      background:linear-gradient(90deg, var(--accent), var(--accent-2))}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px}
    .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.9em; border:1px solid var(--border); padding:.12em .5em; border-radius:6px; background:var(--surface)}

    /* ---------- Buttons ---------- */
    .btn{
      display:inline-flex; align-items:center; gap:10px; border:1px solid var(--border); background:var(--surface);
      padding:12px 16px; border-radius:12px; color:var(--text); text-decoration:none; cursor:pointer;
      transition: transform .15s ease, filter .15s ease;
      font-weight:600;
    }
    .btn.primary{border:none; color:white; background:linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow)}
    .btn.ghost{background:transparent}
    .btn.icon{width:44px; height:44px; display:grid; place-items:center; padding:0}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:none}
    .danger{color:var(--danger)}
    .success{color:var(--success)}
    .muted{color:var(--muted)}
    h1{font-size:clamp(1.35rem,2.6vw,1.7rem); line-height:1.1; font-weight:800}

    /* ---------- Main panels ---------- */
    .panel{
      background: linear-gradient(180deg, var(--surface-2), transparent);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
    }
    .hanzi-card{display:grid; gap:14px; align-content:start; min-height:560px}
    .topline{display:flex; align-items:center; justify-content:space-between}
    .srs-badge{font-size:.85rem; padding:4px 10px; border:1px solid var(--border); border-radius:999px}
    .hanzi{
      text-align:center; font-weight:900; font-size: clamp(90px, 16vw, 180px); line-height:1; letter-spacing:-.02em;
      text-shadow: 0 10px 60px color-mix(in oklab, var(--accent), transparent 65%);
      margin-top:2px;
    }
    .prompt{display:flex; align-items:center; justify-content:center; gap:10px}
    .prompt .mode{padding:4px 10px; border:1px solid var(--border); border-radius:999px; font-size:.85rem}

    .input-row{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch}
    .input{
      flex:1; display:flex; align-items:center; gap:10px; background:var(--bg-2); border:1px solid var(--border);
      padding:14px 16px; border-radius:12px;
    }
    .input input{flex:1; background:transparent; color:var(--text); border:none; outline:none; font-size:1.05rem}
    .input.good{box-shadow: 0 0 0 2px color-mix(in oklab, var(--success), transparent 60%) inset}
    .input.bad{animation: shake .25s linear 0s 1}
    @keyframes shake{25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:none}}

    .result{display:none; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface)}
    .result.show{display:block}
    .result.ok{border-color: color-mix(in oklab, var(--success), transparent 40%)}
    .result.bad{border-color: color-mix(in oklab, var(--danger), transparent 40%)}

    .controls{display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between}
    .left-controls,.right-controls{display:flex; flex-wrap:wrap; gap:10px}

    /* ---------- Context drawer (off by default) ---------- */
    .drawer{display:none; border:1px solid var(--border); border-radius:14px; background:var(--surface); padding:12px}
    .drawer.open{display:block}
    .ctx-grid{display:grid; gap:10px}
    .ctx-card{border:1px solid var(--border); border-radius:12px; padding:10px; background:var(--bg-2)}
    .ctx-pin{font-style:italic; color:var(--muted)}

    /* ---------- Right panel: tabs & info ---------- */
    .tabs{display:flex; gap:8px; border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:8px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:12px; border:1px solid transparent; cursor:pointer; font-weight:600}
    .tab[aria-selected="true"]{border-color:var(--border); background:var(--surface)}
    .tabpanel{display:none}
    .tabpanel.active{display:block}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:10px 16px; align-items:start}
    @media (max-width: 520px){ .kv{grid-template-columns:1fr} }
    .tianzi{position:relative; width:240px; aspect-ratio:1/1; border:1px solid var(--border); background:var(--surface); border-radius:12px; overflow:hidden}
    .tianzi::before, .tianzi::after{content:""; position:absolute; inset:0; background:
      linear-gradient(transparent 49.3%, var(--border) 49.3% 50.7%, transparent 50.7%),
      linear-gradient(90deg, transparent 49.3%, var(--border) 49.3% 50.7%, transparent 50.7%);
      opacity:.55}
    .stroke{position:absolute; height:3px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius:3px; transform-origin:left; opacity:.9}
    .stroke.hidden{opacity:.07}
    .stroke-num{position:absolute; font-size:.75rem; color:var(--muted)}

    /* ---------- Toast & dialogs ---------- */
    .toast{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); z-index:60; padding:10px 14px; border-radius:10px; background:var(--surface); border:1px solid var(--border)}
    dialog{border:none; border-radius:16px; padding:0; background:linear-gradient(180deg, var(--surface-2), transparent); box-shadow:var(--shadow); color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:18px}

    /* ---------- Summary dialog ---------- */
    .sum-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .ring{--pct:0; width:120px; height:120px; border-radius:50%; background:conic-gradient(var(--success) calc(var(--pct)*1%), var(--surface-2) 0); display:grid; place-items:center}
    .ring span{background:var(--bg); border:1px solid var(--border); border-radius:50%; width:82px; height:82px; display:grid; place-items:center; font-weight:800}
    .sum-grid{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    @media (max-width: 720px){ .sum-grid{grid-template-columns:1fr} }
    .list{display:grid; gap:8px; max-height:38vh; overflow:auto}
    .list-item{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px}
    .confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
    .f{position:absolute; width:8px; height:14px; opacity:.9; transform:translateY(-20px); animation: fall 1200ms ease-in forwards}
    @keyframes fall{
      0%{transform:translateY(-20px) rotate(0)}
      100%{transform:translateY(140%) rotate(540deg)}
    }

    /* ---------- Settings sheet ---------- */
    .sheet{position:fixed; top:0; right:0; width:min(420px, 100vw); height:100%; background:color-mix(in oklab, var(--bg), transparent 15%); backdrop-filter:blur(10px); border-left:1px solid var(--border); padding:16px; box-shadow:var(--shadow); transform:translateX(100%); transition: transform .25s ease; z-index:55}
    .sheet.open{transform:none}
    .toggle{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 12px; border:1px solid var(--border); border-radius:12px}

    /* ---------- Reduced motion ---------- */
    @media (prefers-reduced-motion: reduce){ .btn{transition:none} .input.bad{animation:none} }
  </style>
</head>
<body>
  <div class="bg-wrap" aria-hidden="true"><div class="bg-grid"></div></div>

  <!-- NAV -->
  <nav class="nav" aria-label="Primary">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="Back to home">
        <span class="brand-badge" aria-hidden="true">汉</span>
        <span>Hanzi SRS</span>
        <span class="mini-badge">Reviews</span>
      </a>
      <div class="row">
        <button id="openHelp" class="btn icon" aria-label="Keyboard shortcuts (?)" title="Shortcuts (?)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 17h.01M9.09 9a3 3 0 1 1 5.83 1c0 2-3 2-3 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button id="openSettings" class="btn icon" aria-label="Settings (S)" title="Settings (S)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8Zm8 4a7.96 7.96 0 0 0-.34-2.29l2.11-1.54-2-3.46-2.46 1a8.03 8.03 0 0 0-3.95-2.3l-.37-2.6h-4l-.37 2.6a8.03 8.03 0 0 0-3.95 2.3l-2.46-1-2 3.46 2.11 1.54A8.1 8.1 0 0 0 4 12c0 .8.12 1.58.34 2.29l-2.11 1.54 2 3.46 2.46-1a8.03 8.03 0 0 0 3.95 2.3l.37 2.6h4l.37-2.6a8.03 8.03 0 0 0 3.95-2.3l2.46 1 2-3.46-2.11-1.54c.22-.71.34-1.49.34-2.29Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="container">
    <div class="bar">
      <div class="row">
        <h1 id="sessionTitle">Reviews</h1>
        <div class="progress" role="progressbar" aria-label="Session progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <span id="progressFill"></span>
        </div>
        <span class="muted" id="progressText">0 / 0</span>
      </div>
      <div class="row">
        <span class="pill">Remaining: <strong id="remaining">—</strong></span>
        <span class="pill">Accuracy: <strong id="accuracy">—</strong></span>
        <span class="pill">Time: <strong id="elapsed">0:00</strong></span>
        <button id="endBtn" class="btn danger" title="End session (E)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 19h12M6 5h12M6 5v14M18 5v14" stroke="currentColor" stroke-width="2"/></svg>
          End
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container grid grid-2" style="margin-top:10px">
    <!-- LEFT: Review card -->
    <section class="panel hanzi-card" aria-live="polite">
      <div class="topline">
        <div class="row">
          <span class="srs-badge" id="srsStage">Apprentice 1</span>
          <span class="mini-badge" id="levelBadge">Level 1 · HSK 1</span>
        </div>
        <div class="row">
          <label class="row" style="gap:8px; cursor:pointer">
            <input id="ctxToggle" type="checkbox" style="accent-color:hsl(257 90% 66%)">
            <span class="pill">Context</span>
          </label>
          <button id="audioBtn" class="btn icon" title="Play audio (A)" aria-label="Play audio">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M11 5 6 9H3v6h3l5 4V5Zm9 7a6 6 0 0 0-6-6v12a6 6 0 0 0 6-6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button id="starBtn" class="btn icon" title="Star / mark leech (L)" aria-pressed="false" aria-label="Star">
            <svg id="starIcon" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m12 3 3.09 6.26L22 10.27l-5 4.9 1.18 6.86L12 18.9 5.82 22 7 15.17l-5-4.9 6.91-1.01L12 3Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <div class="hanzi" id="char">汉</div>

      <div class="prompt">
        <span class="mode" id="modeBadge">Reading</span>
        <span class="muted" id="subPrompt">Type the pinyin with tone marks or numbers. Press <span class="kbd">Enter</span> to submit.</span>
      </div>

      <!-- Reading input -->
      <div id="readingRow" class="input-row">
        <div id="readingBox" class="input" role="group" aria-label="Reading input">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 8v8m-4-6v4M4 8v8m4-10v12M2 19h20" stroke="currentColor" stroke-width="2"/></svg>
          <input id="readingInput" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="e.g., han4 or hàn" aria-label="Reading (pinyin)" />
          <span id="tonePreview" class="muted" aria-hidden="true"></span>
        </div>
        <button id="readingSubmit" class="btn primary" title="Submit (Enter)">Submit</button>
      </div>

      <!-- Meaning input -->
      <div id="meaningRow" class="input-row" style="display:none">
        <div id="meaningBox" class="input" role="group" aria-label="Meaning input">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h10M4 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="meaningInput" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="type the primary meaning" aria-label="Meaning" />
        </div>
        <button id="meaningSubmit" class="btn primary" title="Submit (Enter)">Submit</button>
      </div>

      <!-- Result banner (shows only after answer) -->
      <div id="result" class="result" role="status" aria-live="polite">
        <div class="row" style="justify-content:space-between">
          <div class="stack">
            <strong id="resTitle">Correct ✓</strong>
            <div id="resDetail" class="muted">Nice! Move on.</div>
          </div>
          <div class="row">
            <button id="viewInfoBtn" class="btn">View info</button>
            <button id="acceptTypoBtn" class="btn" style="display:none">Accept as typo</button>
          </div>
        </div>
      </div>

      <!-- Primary controls -->
      <div class="controls">
        <div class="left-controls">
          <button id="hintBtn" class="btn" title="Hint (H)">Hint</button>
          <button id="ignoreBtn" class="btn" title="Ignore once (I)">Ignore once</button>
          <button id="undoBtn" class="btn" title="Undo last (Ctrl/⌘+Z)">Undo</button>
        </div>
        <div class="right-controls">
          <span class="pill">Require tones: <strong id="reqTonesBadge">On</strong></span>
          <span class="pill">Shortcuts: <span class="kbd">Enter</span> · <span class="kbd">H</span> · <span class="kbd">I</span> · <span class="kbd">A</span> · <span class="kbd">?</span></span>
        </div>
      </div>

      <!-- Optional context (off by default) -->
      <div id="contextDrawer" class="drawer">
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <span class="muted">Context with the current item</span>
          <button id="openExamplesTab" class="btn ghost">Open in Examples tab</button>
        </div>
        <div id="contextList" class="ctx-grid"></div>
      </div>
    </section>

    <!-- RIGHT: Info panel -->
    <aside class="panel" aria-label="Item information">
      <nav class="tabs" role="tablist">
        <button class="tab" role="tab" id="tabInfo" aria-selected="true" aria-controls="panelInfo">Info</button>
        <button class="tab" role="tab" id="tabExamples" aria-selected="false" aria-controls="panelExamples">Examples</button>
        <button class="tab" role="tab" id="tabMnemonic" aria-selected="false" aria-controls="panelMnemonic">Mnemonic</button>
        <button class="tab" role="tab" id="tabProgress" aria-selected="false" aria-controls="panelProgress">Progress</button>
      </nav>

      <!-- INFO -->
      <section id="panelInfo" class="tabpanel active" role="tabpanel" aria-labelledby="tabInfo">
        <div class="kv" style="margin-top:6px">
          <div class="muted">Character</div><div><strong id="infoChar">汉</strong> <span class="muted">(<span id="variantInfo">simplified</span>)</span></div>
          <div class="muted">Reading</div><div id="infoReading">hàn</div>
          <div class="muted">Meaning</div><div id="infoMeaning">Chinese (language); Han</div>
          <div class="muted">Radicals</div><div id="infoRadicals">氵 water + 又 again</div>
          <div class="muted">Decomposition</div><div id="infoDecomp">⺡ + 又 → 汉</div>
        </div>

        <div style="margin-top:12px" class="stack">
          <span class="mini-badge">Stroke order</span>
          <div class="row" style="gap:16px; align-items:flex-start">
            <div class="tianzi" id="strokeBox" aria-label="Stroke order diagram"></div>
            <div class="stack">
              <button id="strokePlay" class="btn">Animate</button>
              <button id="strokeReset" class="btn">Reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- EXAMPLES -->
      <section id="panelExamples" class="tabpanel" role="tabpanel" aria-labelledby="tabExamples">
        <div class="stack" style="margin-top:6px">
          <div class="stack">
            <span class="mini-badge">Words</span>
            <div id="wordList" class="list"></div>
          </div>
          <div class="stack">
            <span class="mini-badge">Sentences</span>
            <div id="sentList" class="list"></div>
          </div>
        </div>
      </section>

      <!-- MNEMONIC -->
      <section id="panelMnemonic" class="tabpanel" role="tabpanel" aria-labelledby="tabMnemonic">
        <div class="stack" style="margin-top:6px">
          <p class="muted" id="mnemonicText">氵 water flows to the Han lands — think “water + again” → “Han/Chinese”.</p>
          <label class="muted" for="mnemonicInput">Your note</label>
          <textarea id="mnemonicInput" rows="4" placeholder="Add your own mnemonic…" style="resize:vertical; background:var(--bg-2); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px"></textarea>
          <div class="row"><button id="saveMnemonic" class="btn">Save</button><span id="mnemonicSaved" class="muted" aria-live="polite"></span></div>
        </div>
      </section>

      <!-- PROGRESS -->
      <section id="panelProgress" class="tabpanel" role="tabpanel" aria-labelledby="tabProgress">
        <div class="stack" style="margin-top:6px">
          <div class="kv">
            <div class="muted">SRS Stage</div><div id="progStage">Apprentice 1</div>
            <div class="muted">Next review</div><div id="progNext">—</div>
            <div class="muted">Answered</div><div id="progAnswered">0</div>
            <div class="muted">Accuracy</div><div id="progAcc">—</div>
          </div>
          <div class="stack" style="margin-top:8px">
            <span class="mini-badge">Session history</span>
            <div id="historyList" class="list"></div>
          </div>
        </div>
      </section>
    </aside>
  </main>

  <!-- SETTINGS SHEET -->
  <aside id="settingsSheet" class="sheet" aria-label="Settings" aria-hidden="true">
    <div class="row" style="justify-content:space-between; margin-bottom:6px">
      <h3>Settings</h3>
      <button id="closeSettings" class="btn icon" aria-label="Close settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="stack">
      <div class="toggle"><div><strong>Require tone correctness</strong><div class="muted">Reading must include correct tones</div></div>
        <label><input id="setRequireTones" type="checkbox" checked> </label></div>
      <div class="toggle"><div><strong>Auto‑convert 1–5 → tone marks</strong><div class="muted">Type numbers to add marks</div></div>
        <label><input id="setAutoTones" type="checkbox" checked> </label></div>
      <div class="toggle"><div><strong>Auto‑play audio</strong><div class="muted">Speak character on each card</div></div>
        <label><input id="setAutoplayAudio" type="checkbox" checked> </label></div>
      <div class="toggle"><div><strong>Auto show context after wrong answer</strong><div class="muted">Opens the context drawer when you miss</div></div>
        <label><input id="setAutoContextOnWrong" type="checkbox"> </label></div>
    </div>
  </aside>

  <!-- HELP / SHORTCUTS -->
  <dialog id="helpModal">
    <div class="modal">
      <div class="row" style="justify-content:space-between">
        <h3>Keyboard shortcuts</h3>
        <form method="dialog"><button class="btn icon" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button></form>
      </div>
      <div class="stack" style="margin-top:10px">
        <div class="list-item"><span>Submit</span><span class="kbd">Enter</span></div>
        <div class="list-item"><span>Play audio</span><span class="kbd">A</span></div>
        <div class="list-item"><span>Hint</span><span class="kbd">H</span></div>
        <div class="list-item"><span>Ignore once</span><span class="kbd">I</span></div>
        <div class="list-item"><span>Undo</span><span class="kbd">Ctrl/⌘ + Z</span></div>
        <div class="list-item"><span>Settings</span><span class="kbd">S</span></div>
        <div class="list-item"><span>Shortcuts</span><span class="kbd">?</span></div>
      </div>
    </div>
  </dialog>

  <!-- SUMMARY MODAL (redesigned) -->
  <dialog id="summaryModal">
    <div class="modal" style="position:relative">
      <div class="confetti" id="confetti"></div>
      <div class="sum-head">
        <h3>Session summary</h3>
        <div class="ring" id="accRing" style="--pct:0"><span id="sumAcc">0%</span></div>
      </div>
      <div class="sum-grid" style="margin-top:12px">
        <div class="panel" style="padding:12px">
          <div class="stack">
            <div class="row"><span class="pill">Items reviewed: <strong id="sumCount">0</strong></span></div>
            <div class="row"><span class="pill">Reading accuracy: <strong id="sumReadAcc">—</strong></span></div>
            <div class="row"><span class="pill">Meaning accuracy: <strong id="sumMeanAcc">—</strong></span></div>
            <div class="row"><span class="pill">Time: <strong id="sumTime">—</strong></span></div>
          </div>
        </div>
        <div class="panel" style="padding:12px">
          <div class="stack">
            <span class="mini-badge">Mistakes to revisit</span>
            <div id="missList" class="list"></div>
          </div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="practiceMissBtn" class="btn">Practice mistakes</button>
        <button id="finishBtn" class="btn primary">Finish</button>
      </div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast" style="display:none"></div>

  <script>
    /* =========================
       Demo data (add your API later)
    ==========================*/
    const deck = [
      {
        id: 1, char: '汉', simp:'汉', trad:'漢',
        reading: 'hàn', meaning: ['Chinese','Han','Chinese (language)'],
        components: '氵 water + 又 again', decomp: '⺡ + 又 → 汉', level: 1, hsk: 1,
        words: [
          {han:'汉语', pin:'Hànyǔ', mean:'Chinese language'},
          {han:'汉字', pin:'hànzì', mean:'Chinese character'}
        ],
        sentences: [
          {han:'我在学汉语。', pin:'Wǒ zài xué Hànyǔ.', en:'I’m learning Chinese.'},
          {han:'这个汉字很常见。', pin:'Zhège hànzì hěn chángjiàn.', en:'This character is very common.'}
        ],
        mnemonic: '氵 water flows to the Han lands — water + again ⇒ Han/Chinese.',
        strokes: [{x:20,y:60,w:60},{x:22,y:90,w:52},{x:22,y:120,w:40},{x:120,y:60,w:70},{x:110,y:92,w:90}]
      },
      {
        id: 2, char: '字', simp:'字', trad:'字',
        reading: 'zì', meaning: ['character','letter'],
        components: '宀 roof + 子 child', decomp: '宀 + 子 → 字', level: 1, hsk: 1,
        words: [
          {han:'汉字', pin:'hànzì', mean:'Chinese character'},
          {han:'写字', pin:'xiězì', mean:'to write characters'}
        ],
        sentences:[
          {han:'我会写很多汉字。', pin:'Wǒ huì xiě hěn duō Hànzì.', en:'I can write many Chinese characters.'},
          {han:'这个字怎么念？', pin:'Zhège zì zěnme niàn?', en:'How do you read this character?'}
        ],
        mnemonic:'A child (子) under a roof (宀) learning letters ⇒ “character”.',
        strokes:[{x:30,y:50,w:140},{x:100,y:48,w:70,rot:90},{x:70,y:85,w:100},{x:80,y:120,w:90}]
      },
      {
        id: 3, char: '学', simp:'学', trad:'學',
        reading:'xué', meaning:['to learn','study'],
        components:'⺍ small + 冖 cover + 子 child', decomp:'⺍ + 冖 + 子 → 学', level:1, hsk:1,
        words:[{han:'学习', pin:'xuéxí', mean:'to study'}, {han:'学校', pin:'xuéxiào', mean:'school'}],
        sentences:[
          {han:'他在学校学习中文。', pin:'Tā zài xuéxiào xuéxí Zhōngwén.', en:'He studies Chinese at school.'},
          {han:'学习需要坚持。', pin:'Xuéxí xūyào jiānchí.', en:'Learning requires persistence.'}
        ],
        mnemonic:'A child under a cover learning little by little ⇒ “learn”.',
        strokes:[{x:40,y:50,w:120},{x:60,y:78,w:80},{x:70,y:110,w:70},{x:80,y:140,w:60}]
      },
      {
        id: 4, char:'谢', simp:'谢', trad:'謝',
        reading:'xiè', meaning:['to thank','thanks'],
        components:'讠speech + 射 shoot', decomp:'讠 + 射 → 谢', level:1, hsk:1,
        words:[{han:'谢谢', pin:'xièxie', mean:'thanks'}, {han:'道谢', pin:'dàoxiè', mean:'to express thanks'}],
        sentences:[
          {han:'谢谢你的帮助。', pin:'Xièxie nǐ de bāngzhù.', en:'Thank you for your help.'},
          {han:'他向老师道谢。', pin:'Tā xiàng lǎoshī dàoxiè.', en:'He expressed thanks to the teacher.'}
        ],
        mnemonic:'Speech (讠) + shoot (射) — shoot words of gratitude ⇒ “thank”.',
        strokes:[{x:28,y:60,w:60},{x:30,y:90,w:50},{x:110,y:60,w:90},{x:110,y:90,w:90}]
      },
      {
        id: 5, char:'好', simp:'好', trad:'好',
        reading:'hǎo', meaning:['good','well','fine'],
        components:'女 woman + 子 child', decomp:'女 + 子 → 好', level:1, hsk:1,
        words:[{han:'你好', pin:'nǐhǎo', mean:'hello'}, {han:'好吃', pin:'hǎochī', mean:'delicious'}],
        sentences:[
          {han:'今天天气很好。', pin:'Jīntiān tiānqì hěn hǎo.', en:'The weather is very good today.'},
          {han:'祝你周末愉快！', pin:'Zhù nǐ zhōumò yúkuài!', en:'Have a nice weekend!'}
        ],
        mnemonic:'Woman + child — a “good” sign of family.',
        strokes:[{x:40,y:60,w:80},{x:100,y:90,w:90},{x:80,y:120,w:80}]
      },
      {
        id: 6, char:'语', simp:'语', trad:'語',
        reading:'yǔ', meaning:['language','speech'],
        components:'讠speech + 吾 I', decomp:'讠 + 吾 → 语', level:1, hsk:1,
        words:[{han:'语言', pin:'yǔyán', mean:'language'}, {han:'语法', pin:'yǔfǎ', mean:'grammar'}],
        sentences:[
          {han:'他的语言能力很强。', pin:'Tā de yǔyán nénglì hěn qiáng.', en:'His language ability is strong.'},
          {han:'我们在课上学语法。', pin:'Wǒmen zài kè shàng xué yǔfǎ.', en:'We study grammar in class.'}
        ],
        mnemonic:'Words (讠) from self (吾) ⇒ language.',
        strokes:[{x:28,y:60,w:60},{x:110,y:60,w:90},{x:110,y:90,w:90}]
      }
    ].map(c => ({
      ...c,
      srs: {stage:1, reps:0, wrong:0, due: Date.now()},
      user: {synonyms:[], note:''}
    }));

    /* =========================
       Storage & settings
    ==========================*/
    const LS = {
      get(k, fallback){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fallback }catch{ return fallback } },
      set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }
    };
    const SETTINGS_KEY = 'hanziSRS_settings_v2';
    const SYN_KEY = 'hanziSRS_synonyms_v2';
    const NOTE_KEY = 'hanziSRS_notes_v2';
    const settings = Object.assign({
      requireTones: true,
      autoTones: true,
      autoplayAudio: true,
      autoContextOnWrong: false
    }, LS.get(SETTINGS_KEY, {}));
    const userSynonyms = LS.get(SYN_KEY, {});
    const userNotes = LS.get(NOTE_KEY, {});

    /* =========================
       Session state
    ==========================*/
    const state = {
      start: Date.now(),
      queue: [],              // [{id, step:'reading'|'meaning', attempts}]
      active: null,           // current task
      item: null,             // current item
      history: [],            // logs
      correct: 0, total: 0,
      readStats: {ok:0,total:0}, meanStats: {ok:0,total:0}
    };

    // Build queue: shuffle items, then pair reading→meaning for each (keeps context)
    function buildQueue(){
      const due = deck.filter(it => it.srs.due <= Date.now());
      const items = (due.length ? due : deck).slice();
      const ids = shuffle(items.map(i=>i.id));
      const q = [];
      ids.forEach(id => { q.push({id, step:'reading', attempts:0}); q.push({id, step:'meaning', attempts:0}); });
      state.queue = q;
      state.total = q.length;
    }
    function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

    /* =========================
       Pinyin helpers
    ==========================*/
    const VOWELS=['a','e','i','o','u','ü'];
    const TONE_MAP={a:['ā','á','ǎ','à'],e:['ē','é','ě','è'],i:['ī','í','ǐ','ì'],o:['ō','ó','ǒ','ò'],u:['ū','ú','ǔ','ù'],'ü':['ǖ','ǘ','ǚ','ǜ']};
    const DIA_BASE={'ā':'a','á':'a','ǎ':'a','à':'a','ē':'e','é':'e','ě':'e','è':'e','ī':'i','í':'i','ǐ':'i','ì':'i','ō':'o','ó':'o','ǒ':'o','ò':'o','ū':'u','ú':'u','ǔ':'u','ù':'u','ǖ':'ü','ǘ':'ü','ǚ':'ü','ǜ':'ü'};
    function normalizeSpaces(s){ return s.trim().replace(/\s+/g,' ') }
    function diacriticsFromNumeric(s){
      return s.split(/\s+/).map(syl=>{
        const m=syl.match(/(.*?)([1-5])$/); if(!m) return syl.replace(/u:|v/g,'ü');
        let base=m[1].replace(/u:|v/g,'ü'), tone=+m[2];
        if(tone===5) return base;
        const lower=base.toLowerCase();
        let idx=-1,v=''; if(lower.includes('a')){idx=lower.indexOf('a');v='a'}
        else if(lower.includes('e')){idx=lower.indexOf('e');v='e'}
        else if(lower.includes('ou')){idx=lower.indexOf('o');v='o'}
        else{ for(let i=base.length-1;i>=0;i--){const ch=lower[i]; if(VOWELS.includes(ch)){idx=i;v=ch;break}}}
        if(idx>=0){ const rep=TONE_MAP[v][tone-1]; base=base.slice(0,idx)+rep+base.slice(idx+1) }
        return base;
      }).join(' ');
    }
    function numericFromDiacritics(s){
      return s.split(/\s+/).map(syl=>{
        let tone=5, base='';
        for(const ch of syl){
          if(DIA_BASE[ch]){ tone={'ā':1,'á':2,'ǎ':3,'à':4,'ē':1,'é':2,'ě':3,'è':4,'ī':1,'í':2,'ǐ':3,'ì':4,'ō':1,'ó':2,'ǒ':3,'ò':4,'ū':1,'ú':2,'ǔ':3,'ù':4,'ǖ':1,'ǘ':2,'ǚ':3,'ǜ':4}[ch]; base+=DIA_BASE[ch]; }
          else if(ch==='v'){ base+='ü' } else { base+=ch }
        }
        base=base.replace(/u:/g,'ü'); return base+(tone===5?'':tone);
      }).join(' ');
    }
    function normalizeReading(s){
      s=s.toLowerCase().trim().replace(/\s+/g,' ').replace(/u:|v/g,'ü');
      return s;
    }
    function toneColorize(s){
      return s.split(/\s+/).map(syl=>{
        let tone=5, base=syl;
        const m=syl.match(/([1-5])$/);
        if(m) { tone=+m[1]; base=diacriticsFromNumeric(syl) }
        else { for(const ch of syl){ if(DIA_BASE[ch]){ tone={'ā':1,'á':2,'ǎ':3,'à':4,'ē':1,'é':2,'ě':3,'è':4,'ī':1,'í':2,'ǐ':3,'ì':4,'ō':1,'ó':2,'ǒ':3,'ò':4,'ū':1,'ú':2,'ǔ':3,'ù':4,'ǖ':1,'ǘ':2,'ǚ':3,'ǜ':4}[ch]; break } } }
        return `<span class="tone-${tone}">${base}</span>`;
      }).join(' ');
    }

    /* =========================
       Meaning helpers
    ==========================*/
    function normalizeMeaning(s){
      return s.toLowerCase().trim()
        .replace(/[’'"]/g,'')
        .replace(/[-_]/g,' ')
        .replace(/[^\p{Letter}\p{Number}\s]/gu,'')
        .replace(/\s+/g,' ');
    }
    function levenshtein(a,b){
      a=a||''; b=b||''; const m=a.length,n=b.length; const dp=new Array(n+1).fill(0).map((_,j)=>j);
      for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i;
        for(let j=1;j<=n;j++){ const tmp=dp[j]; const cost=a[i-1]===b[j-1]?0:1; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+cost); prev=tmp; }
      } return dp[n];
    }

    /* =========================
       Audio (Web Speech)
    ==========================*/
    let voices=[]; function loadVoices(){ voices=speechSynthesis.getVoices().filter(v=>/zh|cmn/i.test(v.lang)) }
    if('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged=loadVoices }
    function speak(text){ if(!settings.autoplayAudio) return;
      if('speechSynthesis' in window && voices.length){ const u=new SpeechSynthesisUtterance(text); u.lang=voices[0].lang; u.voice=voices[0]; speechSynthesis.cancel(); speechSynthesis.speak(u)}
    }

    /* =========================
       UI refs
    ==========================*/
    const els = {
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      remaining: document.getElementById('remaining'),
      accuracy: document.getElementById('accuracy'),
      elapsed: document.getElementById('elapsed'),
      endBtn: document.getElementById('endBtn'),

      char: document.getElementById('char'),
      srsStage: document.getElementById('srsStage'),
      levelBadge: document.getElementById('levelBadge'),

      modeBadge: document.getElementById('modeBadge'),
      subPrompt: document.getElementById('subPrompt'),

      readingRow: document.getElementById('readingRow'),
      readingBox: document.getElementById('readingBox'),
      readingInput: document.getElementById('readingInput'),
      readingSubmit: document.getElementById('readingSubmit'),
      tonePreview: document.getElementById('tonePreview'),

      meaningRow: document.getElementById('meaningRow'),
      meaningBox: document.getElementById('meaningBox'),
      meaningInput: document.getElementById('meaningInput'),
      meaningSubmit: document.getElementById('meaningSubmit'),

      result: document.getElementById('result'),
      resTitle: document.getElementById('resTitle'),
      resDetail: document.getElementById('resDetail'),
      viewInfoBtn: document.getElementById('viewInfoBtn'),
      acceptTypoBtn: document.getElementById('acceptTypoBtn'),

      hintBtn: document.getElementById('hintBtn'),
      ignoreBtn: document.getElementById('ignoreBtn'),
      undoBtn: document.getElementById('undoBtn'),
      audioBtn: document.getElementById('audioBtn'),
      starBtn: document.getElementById('starBtn'),
      starIcon: document.getElementById('starIcon'),

      // Context
      ctxToggle: document.getElementById('ctxToggle'),
      contextDrawer: document.getElementById('contextDrawer'),
      contextList: document.getElementById('contextList'),
      openExamplesTab: document.getElementById('openExamplesTab'),

      // Tabs
      tabs: {info: document.getElementById('tabInfo'), examples: document.getElementById('tabExamples'), mnemonic: document.getElementById('tabMnemonic'), progress: document.getElementById('tabProgress')},
      panels: {info: document.getElementById('panelInfo'), examples: document.getElementById('panelExamples'), mnemonic: document.getElementById('panelMnemonic'), progress: document.getElementById('panelProgress')},

      // Info panel
      infoChar: document.getElementById('infoChar'),
      variantInfo: document.getElementById('variantInfo'),
      infoReading: document.getElementById('infoReading'),
      infoMeaning: document.getElementById('infoMeaning'),
      infoRadicals: document.getElementById('infoRadicals'),
      infoDecomp: document.getElementById('infoDecomp'),
      strokeBox: document.getElementById('strokeBox'),
      strokePlay: document.getElementById('strokePlay'),
      strokeReset: document.getElementById('strokeReset'),

      wordList: document.getElementById('wordList'),
      sentList: document.getElementById('sentList'),
      mnemonicText: document.getElementById('mnemonicText'),
      mnemonicInput: document.getElementById('mnemonicInput'),
      mnemonicSaved: document.getElementById('mnemonicSaved'),
      saveMnemonic: document.getElementById('saveMnemonic'),

      progStage: document.getElementById('progStage'),
      progNext: document.getElementById('progNext'),
      progAnswered: document.getElementById('progAnswered'),
      progAcc: document.getElementById('progAcc'),
      historyList: document.getElementById('historyList'),

      // Settings / Help
      openSettings: document.getElementById('openSettings'),
      settingsSheet: document.getElementById('settingsSheet'),
      closeSettings: document.getElementById('closeSettings'),
      setRequireTones: document.getElementById('setRequireTones'),
      setAutoTones: document.getElementById('setAutoTones'),
      setAutoplayAudio: document.getElementById('setAutoplayAudio'),
      setAutoContextOnWrong: document.getElementById('setAutoContextOnWrong'),

      openHelp: document.getElementById('openHelp'),
      helpModal: document.getElementById('helpModal'),

      // Summary
      summaryModal: document.getElementById('summaryModal'),
      confetti: document.getElementById('confetti'),
      accRing: document.getElementById('accRing'),
      sumAcc: document.getElementById('sumAcc'),
      sumCount: document.getElementById('sumCount'),
      sumReadAcc: document.getElementById('sumReadAcc'),
      sumMeanAcc: document.getElementById('sumMeanAcc'),
      sumTime: document.getElementById('sumTime'),
      missList: document.getElementById('missList'),
      finishBtn: document.getElementById('finishBtn'),
      practiceMissBtn: document.getElementById('practiceMissBtn'),

      // Toast
      toast: document.getElementById('toast'),
      reqTonesBadge: document.getElementById('reqTonesBadge')
    };

    /* =========================
       Tabs logic
    ==========================*/
    function activateTab(which){
      for(const id of Object.keys(els.tabs)){
        els.tabs[id].setAttribute('aria-selected', String(id===which));
        els.panels[id].classList.toggle('active', id===which);
      }
    }
    Object.entries(els.tabs).forEach(([id,btn])=>btn.addEventListener('click',()=>activateTab(id)));
    els.openExamplesTab.addEventListener('click', ()=>activateTab('examples'));

    /* =========================
       Strokes (simple anim)
    ==========================*/
    let strokeTimer=null;
    function drawStrokes(item){
      els.strokeBox.innerHTML='';
      (item.strokes||[]).forEach((s,idx)=>{
        const bar=document.createElement('div'); bar.className='stroke hidden';
        bar.style.left=s.x+'px'; bar.style.top=s.y+'px'; bar.style.width=s.w+'px'; bar.style.transform=`rotate(${s.rot||0}deg)`; els.strokeBox.appendChild(bar);
        const num=document.createElement('div'); num.className='stroke-num'; num.style.left=(s.x-14)+'px'; num.style.top=(s.y-8)+'px'; num.textContent=idx+1; els.strokeBox.appendChild(num);
      });
    }
    function animateStrokes(){ clearInterval(strokeTimer); const bars=[...els.strokeBox.querySelectorAll('.stroke')]; bars.forEach(b=>b.classList.add('hidden')); let i=0;
      strokeTimer=setInterval(()=>{ if(i>=bars.length){clearInterval(strokeTimer);return} bars[i].classList.remove('hidden'); i++ }, 400);
    }
    function resetStrokes(){ clearInterval(strokeTimer); [...els.strokeBox.querySelectorAll('.stroke')].forEach(b=>b.classList.add('hidden')) }
    els.strokePlay.addEventListener('click', animateStrokes);
    els.strokeReset.addEventListener('click', resetStrokes);

    /* =========================
       Render & header
    ==========================*/
    function nextTask(){
      if(!state.queue.length){ endSession(); return }
      state.active = state.queue[0]; // peek, do NOT shift until correct
      state.item = deck.find(d=>d.id===state.active.id);
      renderCard();
      if(settings.autoplayAudio && state.active.step==='reading'){ speak(state.item.char) }
    }

    function renderCard(){
      // reset UI
      hideResult();
      els.readingBox.classList.remove('good','bad');
      els.meaningBox.classList.remove('good','bad');

      const it=state.item, step=state.active.step;
      els.char.textContent=it.char;
      els.srsStage.textContent=stageName(it.srs.stage);
      els.levelBadge.textContent=`Level ${it.level} · HSK ${it.hsk}`;
      els.modeBadge.textContent= step==='reading' ? 'Reading' : 'Meaning';
      els.subPrompt.innerHTML = step==='reading'
        ? 'Type the pinyin with tone marks or numbers. Press <span class="kbd">Enter</span> to submit.'
        : 'Type the primary meaning. Press <span class="kbd">Enter</span> to submit.';
      els.reqTonesBadge.textContent = settings.requireTones ? 'On' : 'Off';

      els.readingRow.style.display = step==='reading' ? '' : 'none';
      els.meaningRow.style.display  = step==='meaning' ? '' : 'none';

      // Prefill info panel
      updateInfoPanel(it);
      // Context (off by default; not auto-open unless setting + wrong)
      buildContext(it);
      els.ctxToggle.checked = false;
      toggleContext(false);

      // Focus appropriate input
      (step==='reading' ? els.readingInput : els.meaningInput).focus();
      // Tone preview
      els.tonePreview.innerHTML = settings.requireTones ? toneColorize(numericFromDiacritics(it.reading)) : '';
      updateHeader();
      drawStrokes(it);
      setTimeout(animateStrokes, 200);
    }

    function updateHeader(){
      const done = state.history.length;
      els.progressText.textContent = `${done} / ${state.total}`;
      const fill = state.total ? Math.min(1, done/state.total) : 0;
      els.progressFill.style.transform = `scaleX(${fill})`;
      els.remaining.textContent = String(Math.max(0, state.total - done));
      els.accuracy.textContent = state.history.length ? Math.round((state.correct/state.history.length)*100) + '%' : '—';
    }

    function updateInfoPanel(it){
      els.infoChar.textContent = it.char;
      els.variantInfo.textContent = it.simp===it.trad ? 'both' : 'simplified';
      els.infoReading.textContent = it.reading;
      els.infoMeaning.textContent = it.meaning.join('; ');
      els.infoRadicals.textContent = it.components;
      els.infoDecomp.textContent = it.decomp;
      // words
      els.wordList.innerHTML='';
      for(const w of it.words||[]){
        const div=document.createElement('div'); div.className='list-item';
        div.innerHTML=`<span><strong>${w.han}</strong> · <em>${w.pin}</em></span><span class="muted">${w.mean}</span>`;
        els.wordList.appendChild(div);
      }
      // sentences
      els.sentList.innerHTML='';
      for(const s of it.sentences||[]){
        const div=document.createElement('div'); div.className='list-item';
        // bold the target char in sentence
        const highlighted = s.han.replace(new RegExp(it.char,'g'), `<strong>${it.char}</strong>`);
        div.innerHTML=`<span>${highlighted}<div class="muted" style="margin-top:4px">${s.pin}</div></span><span class="muted">${s.en}</span>`;
        els.sentList.appendChild(div);
      }
      // mnemonic
      els.mnemonicText.textContent = it.mnemonic || '';
      els.mnemonicInput.value = userNotes[it.char] || '';
      // progress tab
      const answered = state.history.filter(h=>h.id===it.id).length;
      const ok = state.history.filter(h=>h.id===it.id && h.ok).length;
      els.progStage.textContent = stageName(it.srs.stage);
      els.progNext.textContent = dueIn(it.srs.due);
      els.progAnswered.textContent = String(answered);
      els.progAcc.textContent = answered ? Math.round(ok/answered*100)+'%' : '—';
      rebuildHistory();
    }
    function rebuildHistory(){
      els.historyList.innerHTML='';
      state.history.slice(-12).reverse().forEach(h=>{
        const div=document.createElement('div'); div.className='list-item';
        div.innerHTML = `<span>${h.char} · ${h.step}</span><span class="${h.ok?'success':'danger'}">${h.ok?'✓':'✕'}</span>`;
        els.historyList.appendChild(div);
      });
    }

    function stageName(n){
      if(n<=4) return `Apprentice ${n}`;
      if(n<=6) return `Guru ${n-4}`;
      if(n===7) return 'Master';
      if(n===8) return 'Enlightened';
      return 'Burned';
    }
    function dueIn(ts){
      const d=ts-Date.now(); if(d<=0) return 'now';
      const s=Math.round(d/1000); if(s<60) return s+'s';
      const m=Math.round(s/60); if(m<60) return m+'m';
      const h=Math.round(m/60); if(h<48) return h+'h'; const days=Math.round(h/24); return days+'d';
    }

    /* =========================
       Context drawer
    ==========================*/
    function buildContext(it){
      els.contextList.innerHTML='';
      for(const s of it.sentences||[]){
        const card=document.createElement('div'); card.className='ctx-card';
        const highlighted=s.han.replace(new RegExp(it.char,'g'), `<strong>${it.char}</strong>`);
        card.innerHTML = `<div>${highlighted}</div><div class="ctx-pin">${s.pin}</div><div class="muted">${s.en}</div>`;
        els.contextList.appendChild(card);
      }
    }
    function toggleContext(open){
      els.contextDrawer.classList.toggle('open', !!open);
    }
    els.ctxToggle.addEventListener('change', e=>toggleContext(e.target.checked));

    /* =========================
       SRS (toy)
    ==========================*/
    const INTERVALS = { // hours
      1:4, 2:8, 3:24, 4:48, 5:7*24, 6:14*24, 7:30*24, 8:120*24, 9:Infinity
    };
    function promote(it){
      it.srs.stage = Math.min(9, it.srs.stage+1);
      it.srs.reps++;
      const h = INTERVALS[it.srs.stage] || 24;
      it.srs.due = Date.now() + h*60*60*1000;
    }
    function demote(it){
      it.srs.stage = Math.max(1, it.srs.stage-1);
      it.srs.wrong++;
      it.srs.due = Date.now() + 30*60*1000;
    }

    /* =========================
       Checking + flow
    ==========================*/
    function showResult(ok, detail, options={}){
      els.result.className='result show '+(ok?'ok':'bad');
      els.resTitle.textContent = ok ? 'Correct ✓' : 'Incorrect';
      els.resDetail.innerHTML = detail || '';
      els.acceptTypoBtn.style.display = options.typo ? '' : 'none';
    }
    function hideResult(){ els.result.className='result'; els.resTitle.textContent=''; els.resDetail.textContent=''; els.acceptTypoBtn.style.display='none' }

    function checkReading(input, item){
      input = normalizeSpaces(input);
      const empty = !input;
      let user = /\d/.test(input) ? input : numericFromDiacritics(input);
      let target = numericFromDiacritics(item.reading);
      user = normalizeReading(user); target = normalizeReading(target);
      if(!settings.requireTones){ user=user.replace(/[1-5]/g,''); target=target.replace(/[1-5]/g,'') }
      const ok = !empty && user === target;
      let typo=false;
      if(!ok && !empty){
        const d = levenshtein(user.replace(/\s+/g,''), target.replace(/\s+/g,''));
        typo = d===1 || (target.length>=6 && d<=2);
      }
      return {ok, empty, user, target, expected:item.reading, typo};
    }
    function checkMeaning(input, item){
      input = normalizeMeaning(input); const empty = !input;
      const canon = item.meaning.map(normalizeMeaning);
      const userSyn = (userSynonyms[item.char]||[]).map(normalizeMeaning);
      const all = new Set([...canon, ...userSyn]);
      const ok = !empty && all.has(input);
      let typo=false, nearest='';
      if(!ok && !empty){
        let best=1e9,bestT='';
        for(const t of all){ const d=levenshtein(input, t); if(d<best){best=d; bestT=t} }
        typo = best===1 || (bestT.length>=6 && best<=2); nearest=bestT;
      }
      return {ok, empty, expected: item.meaning[0], typo, nearest};
    }

    function submitReading(){
      const val = normalizeSpaces(els.readingInput.value);
      const res = checkReading(val, state.item);
      state.readStats.total++;
      if(res.ok){
        state.readStats.ok++;
        els.readingBox.classList.add('good');
        state.history.push({id:state.item.id, char:state.item.char, step:'reading', ok:true, input:val, expected:res.expected});
        state.correct++;
        showResult(true, `Reading: <strong>${state.item.reading}</strong>`);
        // advance to meaning of same item (the queue already pairs; we now SHIFT this task)
        state.queue.shift(); // remove reading
        nextTask(); // will render meaning (pair is now at queue[0])
      } else {
        els.readingBox.classList.add('bad');
        const det = res.empty ? 'Please enter an answer.' :
          res.typo ? 'Almost — looks like a typo. You can <em>accept as typo</em>.' :
          'Try again. You can use 1–5 for tone numbers.';
        showResult(false, det, {typo: res.typo});
        // demote only on first wrong attempt
        if(state.active.attempts===0 && !res.empty){ demote(state.item) }
        state.active.attempts++;
        state.history.push({id:state.item.id, char:state.item.char, step:'reading', ok:false, input:val, expected:res.expected});
        // DO NOT advance
      }
      updateHeader();
    }

    function submitMeaning(){
      const val = normalizeSpaces(els.meaningInput.value);
      const res = checkMeaning(val, state.item);
      state.meanStats.total++;
      if(res.ok){
        state.meanStats.ok++;
        els.meaningBox.classList.add('good');
        state.history.push({id:state.item.id, char:state.item.char, step:'meaning', ok:true, input:val, expected:res.expected});
        state.correct++;
        showResult(true, `Meaning: <strong>${state.item.meaning[0]}</strong>`);
        // Promote on full success of meaning step; shift the meaning task and move on
        promote(state.item);
        state.queue.shift(); // remove meaning
        // move to next pair
        nextTask();
      } else {
        els.meaningBox.classList.add('bad');
        const det = res.empty ? 'Please enter an answer.' :
          res.typo ? `Almost “${res.nearest}”. You can <em>accept as typo</em> or try again.` :
          'Not quite. Try again or add a synonym if yours is valid.';
        showResult(false, det, {typo: res.typo});
        if(settings.autoContextOnWrong){ els.ctxToggle.checked = true; toggleContext(true) }
        if(state.active.attempts===0 && !res.empty){ demote(state.item) }
        state.active.attempts++;
        state.history.push({id:state.item.id, char:state.item.char, step:'meaning', ok:false, input:val, expected:res.expected});
      }
      updateHeader();
    }

    function handleSubmit(){
      if(!state.active) return;
      if(state.active.step==='reading'){ submitReading() } else { submitMeaning() }
    }

    /* =========================
       Controls & events
    ==========================*/
    // Enter submits
    function onEnter(e){ if(e.key==='Enter'){ e.preventDefault(); handleSubmit() } }
    els.readingInput.addEventListener('keydown', onEnter);
    els.meaningInput.addEventListener('keydown', onEnter);
    els.readingSubmit.addEventListener('click', submitReading);
    els.meaningSubmit.addEventListener('click', submitMeaning);

    // Typo accept
    els.acceptTypoBtn.addEventListener('click', ()=>{
      if(!state.active) return;
      // Treat as correct but do NOT promote/demote; just advance
      state.history.push({id:state.item.id, char:state.item.char, step:state.active.step, ok:true, input:'(typo accepted)'});
      state.correct++;
      if(state.active.step==='reading'){ state.queue.shift(); nextTask() }
      else { state.queue.shift(); nextTask() }
      updateHeader();
    });

    // View info button focuses right panel and Info tab
    els.viewInfoBtn.addEventListener('click', ()=>activateTab('info'));

    // Hint
    els.hintBtn.addEventListener('click', ()=>{
      if(!state.active) return;
      const it=state.item;
      if(state.active.step==='reading'){
        const num=numericFromDiacritics(it.reading);
        const first=num.split(/\s+/)[0].slice(0,2);
        showResult(false, `Hint: starts with “${diacriticsFromNumeric(first)}…”`);
      } else {
        const ans=it.meaning[0]; showResult(false, `Hint: “${ans.slice(0,1)}…${ans.slice(-1)}” (${ans.length} letters)`);
      }
    });

    // Ignore once (skip current step, no promotion/demotion)
    els.ignoreBtn.addEventListener('click', ()=>{
      if(!state.active) return;
      state.history.push({id:state.item.id, char:state.item.char, step:state.active.step, ok:true, input:'(ignored)'});
      state.correct++; toast('Ignored once ✓');
      state.queue.shift(); nextTask(); updateHeader();
    });

    // Undo = remove last history entry and reinsert its task at front
    els.undoBtn.addEventListener('click', ()=>{
      const last=state.history.pop(); if(!last){ toast('Nothing to undo'); return }
      state.correct = Math.max(0, state.correct - (last.ok?1:0));
      // Put the undone task back to front
      state.queue.unshift({id:last.id, step:last.step, attempts:0});
      toast('Undid last action'); nextTask(); updateHeader();
    });

    // Audio
    els.audioBtn.addEventListener('click', ()=>speak(state.item.char));

    // Star
    els.starBtn.addEventListener('click', ()=>{
      const pressed = els.starBtn.getAttribute('aria-pressed')==='true';
      els.starBtn.setAttribute('aria-pressed', String(!pressed));
      els.starIcon.style.fill = pressed ? 'none' : 'currentColor';
      toast(!pressed ? 'Starred' : 'Unstarred');
    });

    // Reading typing: auto tones & live preview
    els.readingInput.addEventListener('input', ()=>{
      const prev=els.readingInput.value;
      if(settings.autoTones){
        const m=prev.match(/(.+?)([a-zü:V]+)([1-5])$/i);
        if(m){ const before=m[1]; const syl=m[2].replace(/V|v|u:/g,'ü'); const tone=m[3]; const replaced=diacriticsFromNumeric(syl+tone); els.readingInput.value=before+replaced+' ' }
      }
      const numeric=/\d/.test(prev)?prev:numericFromDiacritics(prev);
      els.tonePreview.innerHTML=toneColorize(numeric);
    });

    // Settings
    function openSettings(){ els.settingsSheet.classList.add('open'); els.settingsSheet.setAttribute('aria-hidden','false') }
    function closeSettings(){ els.settingsSheet.classList.remove('open'); els.settingsSheet.setAttribute('aria-hidden','true') }
    els.openSettings.addEventListener('click', openSettings);
    els.closeSettings.addEventListener('click', closeSettings);
    // init toggles
    els.setRequireTones.checked=!!settings.requireTones;
    els.setAutoTones.checked=!!settings.autoTones;
    els.setAutoplayAudio.checked=!!settings.autoplayAudio;
    els.setAutoContextOnWrong.checked=!!settings.autoContextOnWrong;
    els.setRequireTones.addEventListener('change', e=>{ settings.requireTones=e.target.checked; LS.set(SETTINGS_KEY, settings); els.reqTonesBadge.textContent = settings.requireTones?'On':'Off' });
    els.setAutoTones.addEventListener('change', e=>{ settings.autoTones=e.target.checked; LS.set(SETTINGS_KEY, settings) });
    els.setAutoplayAudio.addEventListener('change', e=>{ settings.autoplayAudio=e.target.checked; LS.set(SETTINGS_KEY, settings) });
    els.setAutoContextOnWrong.addEventListener('change', e=>{ settings.autoContextOnWrong=e.target.checked; LS.set(SETTINGS_KEY, settings) });

    // Help
    els.openHelp.addEventListener('click', ()=>els.helpModal.showModal());

    // Global keys
    document.addEventListener('keydown', (e)=>{
      if(e.key==='?' && !e.ctrlKey && !e.metaKey){ e.preventDefault(); els.helpModal.showModal() }
      if(e.key==='e' || e.key==='E'){ e.preventDefault(); endSession() }
      if(e.key==='a' || e.key==='A'){ e.preventDefault(); els.audioBtn.click() }
      if(e.key==='h' || e.key==='H'){ e.preventDefault(); els.hintBtn.click() }
      if(e.key==='i' || e.key==='I'){ e.preventDefault(); els.ignoreBtn.click() }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); els.undoBtn.click() }
      if(e.key==='s' || e.key==='S'){ e.preventDefault(); openSettings() }
    });

    // Save mnemonic
    els.saveMnemonic.addEventListener('click', ()=>{
      const note=els.mnemonicInput.value.trim(); userNotes[state.item.char]=note; LS.set(NOTE_KEY, userNotes);
      els.mnemonicSaved.textContent='Saved ✓'; setTimeout(()=>els.mnemonicSaved.textContent='',1000);
    });

    /* =========================
       Summary
    ==========================*/
    function endSession(){
      // compute stats
      const total=state.history.length;
      const acc = total ? Math.round((state.history.filter(h=>h.ok).length/total)*100) : 0;
      const rAcc = state.readStats.total ? Math.round(state.readStats.ok/state.readStats.total*100) : 0;
      const mAcc = state.meanStats.total ? Math.round(state.meanStats.ok/state.meanStats.total*100) : 0;
      els.sumCount.textContent=String(total);
      els.sumAcc.textContent=acc+'%';
      els.accRing.style.setProperty('--pct', acc);
      els.sumReadAcc.textContent = state.readStats.total ? rAcc+'%' : '—';
      els.sumMeanAcc.textContent = state.meanStats.total ? mAcc+'%' : '—';
      const dt=Math.round((Date.now()-state.start)/1000); els.sumTime.textContent=`${Math.floor(dt/60)}m ${dt%60}s`;
      els.missList.innerHTML='';
      const misses=state.history.filter(h=>!h.ok).slice(-30);
      if(!misses.length){ els.missList.innerHTML='<div class="muted">No mistakes — great work!</div>' }
      else{
        for(const m of misses){
          const it=deck.find(d=>d.id===m.id);
          const div=document.createElement('div'); div.className='list-item';
          div.innerHTML=`<span>${it.char} · ${m.step}</span><span class="muted">You: ${m.input||'—'} · Ans: ${m.expected||'—'}</span>`;
          els.missList.appendChild(div);
        }
      }
      els.summaryModal.showModal();
      // confetti if good
      if(acc>=80){ burstConfetti() }
    }
    function burstConfetti(){
      els.confetti.innerHTML='';
      for(let i=0;i<40;i++){
        const s=document.createElement('span'); s.className='f';
        s.style.left=Math.random()*100+'%';
        s.style.background = `linear-gradient(135deg, var(--accent), var(--accent-2))`;
        s.style.animationDelay = (Math.random()*0.6)+'s';
        s.style.opacity = 0.7 + Math.random()*0.3;
        els.confetti.appendChild(s);
      }
      setTimeout(()=>els.confetti.innerHTML='', 2000);
    }
    els.finishBtn.addEventListener('click', ()=>els.summaryModal.close());
    els.practiceMissBtn.addEventListener('click', ()=>{
      // Rebuild queue with missed ones
      const missedIds = [...new Set(state.history.filter(h=>!h.ok).map(h=>h.id))];
      if(!missedIds.length){ toast('No mistakes to practice'); return }
      state.queue = []; missedIds.forEach(id=>{ state.queue.push({id, step:'reading', attempts:0}); state.queue.push({id, step:'meaning', attempts:0}); });
      state.total = state.queue.length; state.history=[]; state.correct=0; state.readStats={ok:0,total:0}; state.meanStats={ok:0,total:0};
      els.summaryModal.close(); nextTask(); updateHeader(); toast('Practicing mistakes');
    });

    /* =========================
       Utility
    ==========================*/
    function toast(msg){ els.toast.textContent=msg; els.toast.style.display='block'; clearTimeout(els.toast._t); els.toast._t=setTimeout(()=>els.toast.style.display='none', 1200) }

    // Live elapsed time
    setInterval(()=>{
      const s=Math.floor((Date.now()-state.start)/1000);
      const m=Math.floor(s/60), r=s%60; els.elapsed.textContent = `${m}:${String(r).padStart(2,'0')}`;
    }, 1000);

    // Initialize
    deck.forEach(it=>{ if(userSynonyms[it.char]) it.user.synonyms=userSynonyms[it.char]; if(userNotes[it.char]) it.user.note=userNotes[it.char] });
    buildQueue(); nextTask();

    /* =========================
       Tone colors (CSS helper)
    ==========================*/
    // Inject tone colors once (kept minimal, no extra CSS blocks earlier)
    const style=document.createElement('style'); style.textContent=`
      .tone-1{color:hsl(210 80% 70%)} .tone-2{color:hsl(120 62% 58%)} .tone-3{color:hsl(60 70% 56%)} .tone-4{color:hsl(0 70% 65%)} .tone-5{color:var(--muted)}
    `; document.head.appendChild(style);
  </script>
</body>
</html>
